apiVersion: v1
kind: Namespace
metadata:
  name: falco-system
---
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: falco-secrets-infisical
  namespace: falco-system
spec:
  authentication:
    universalAuth:
      secretsScope:
        projectSlug: cluster-secrets-rgq1
        envSlug: dev
        secretsPath: /falco
        recursive: true
      credentialsRef:
        secretName: infisical-machine-id
        secretNamespace: infisical
  managedSecretReference:
    secretName: falco-secrets
    secretNamespace: falco-system
    creationPolicy: Owner
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: falco
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: falco-system
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: falco
    targetRevision: 4.15.1
    repoURL: https://falcosecurity.github.io/charts
    helm:
      valuesObject:
        serviceMonitor:
          create: true
        metrics:
          enabled: true
        collectors:
          containerd:
            socket: /run/k3s/containerd/containerd.sock
        falcosidekick:
          enabled: true
          config:
            existingSecret: falco-secrets
          serviceMonitor:
            enabled: true
          prometheusRules:
            enabled: true
          webui:
            enabled: true
            disableauth: true
        customRules:
          shut-the-fuck-up.yaml: |
            - list: trusted_k8s_api_container_images
              items:
                - quay.io/argoproj/argocd
            - macro: user_known_contact_k8s_api_server_activities
              condition: or container.image.repository in (trusted_k8s_api_container_images)
              override:
                condition: append

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 5m
