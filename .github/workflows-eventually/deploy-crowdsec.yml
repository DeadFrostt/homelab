name: Deploy Crowdsec configuration

on: # yamllint disable-line rule:truthy
  push:
    paths:
      - docker/crowdsec/config/*
      - docker/crowdsec/tasks.yml
      - .github/workflows/deploy-crowdsec.yml
    branches:
      - main

jobs:
  deploy:
    name: Deploy Crowdsec configuration
    runs-on: self-hosted
    steps:
      - name: Update Repository
        run: |
          cd /homelab
          git reset --hard HEAD
          git pull
      - name: Get most recent secrets
        run: |
          cd /homelab
          cp ~/homelab-secrets.env /homelab/.env
      - name: Produce Crowdsec Configuration
        run: |
          cd /homelab
          task docker:crowdsec:produce
      - name: Deploy Crowdsec configuration
        run: |
          cd /homelab
