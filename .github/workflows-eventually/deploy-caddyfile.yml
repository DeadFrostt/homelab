name: Deploy Cadddyfile

on: # yamllint disable-line rule:truthy
  push:
    paths:
      - reverse-proxy/Caddyfile
      - .github/workflows/deploy-caddyfile.yml
    branches:
      - main

env:
  pool_path: ${{ vars.STORAGEPOOL_ABS_PATH }}

jobs:
  deploy:
    name: Deploy Caddyfile
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Deploy Caddyfile
        run: |
          cp reverse-proxy/Caddyfile ${{ env.pool_path }}/caddy/Caddyfile
          CADDY_CONTAINER_ID=$(docker ps | grep caddy | awk '{print $1;}')
          docker exec $CADDY_CONTAINER_ID caddy reload --config /etc/caddy/Caddyfile --adapter caddyfile
